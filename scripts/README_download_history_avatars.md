# 历史头像下载脚本说明

## 📋 脚本功能

`download_history_avatars.py` 用于将历史数据中的头像URL下载到本地，并更新数据库中的头像地址。

### 主要功能

1. **查询历史数据**: 查找所有头像URL为HTTP/HTTPS格式的记录
2. **去重下载**: 对于相同用户名，只下载一次，避免重复下载
3. **本地保存**: 将所有头像保存到 `images/boniu/avatar` 目录
4. **数据库更新**: 将数据库中的头像URL更新为本地路径
5. **统计报告**: 显示详细的下载和更新统计信息

## 🚀 使用方法

### 前置条件

1. **环境变量配置**: 确保已配置数据库连接信息
   - `DB_HOST`: 数据库主机
   - `DB_PORT`: 数据库端口
   - `DB_USER`: 数据库用户名
   - `DB_PASSWORD`: 数据库密码
   - `DB_NAME`: 数据库名称
   - `BONIU_IMG_BASE_PATH`: 图片保存基础路径（可选）

2. **目录准备**: 确保有写入权限
   - `images/boniu/avatar` 目录会自动创建

### 执行脚本

```bash
# 进入项目根目录
cd D:\me\epiboly\fuye\projects\boniu-crawler

# 执行脚本
python scripts/download_history_avatars.py
```

### 使用示例

```bash
# 开发环境
python scripts/download_history_avatars.py

# 生产环境（需要先设置环境变量）
export BONIU_IMG_BASE_PATH=/path/to/images/boniu
python scripts/download_history_avatars.py
```

## 📊 执行流程

### 步骤1: 查询需要下载的记录
- 查询所有头像URL为HTTP/HTTPS格式的记录
- 排除空用户名和"未知用户"
- 按ID排序，确保处理顺序

### 步骤2: 下载头像（去重）
- 遍历所有记录
- 对于每个用户名，只下载一次
- 如果用户名已存在映射中，跳过下载
- 下载失败时记录错误，继续处理

### 步骤3: 更新数据库
- 对于每个成功下载的头像
- 更新该用户名所有记录的 `avatar_url` 为本地路径
- 批量执行更新操作

### 步骤4: 统计报告
- 显示总记录数
- 显示URL格式头像数量
- 显示本地路径头像数量
- 显示空头像数量

## 📁 文件结构

### 保存位置
```
images/boniu/
└── avatar/
    ├── avatar_xxx.jpg
    ├── avatar_yyy.png
    └── ...
```

### 数据库路径格式
- 更新后的路径格式: `images/boniu/avatar/filename.jpg`

## 📝 日志输出

脚本会输出详细的日志信息：

```
[2025-10-16 10:00:00] INFO: 开始下载历史数据中的头像...
[2025-10-16 10:00:01] INFO: 查询需要下载头像的记录...
[2025-10-16 10:00:02] INFO: 找到 150 条需要下载头像的记录
[2025-10-16 10:00:03] INFO: 处理进度: 100/150, 已下载: 85, 跳过: 10, 错误: 5
[2025-10-16 10:05:00] INFO: 头像下载完成: 成功 120 个, 跳过 25 个, 失败 5 个
[2025-10-16 10:05:01] INFO: 开始更新数据库，共 120 个用户...
[2025-10-16 10:05:02] INFO: 开始批量更新 350 条记录...
[2025-10-16 10:05:03] INFO: 数据库更新完成，影响行数: 350
```

### 日志文件
- 日志文件位置: `logs/download_history_avatars.log`

## ⚠️ 注意事项

### 执行前准备

1. **备份数据**（强烈建议）:
   ```sql
   CREATE TABLE `ims_mdkeji_im_boniu_forum_post_backup_avatar_20251016` AS
   SELECT id, username, avatar_url, updated_at
   FROM `ims_mdkeji_im_boniu_forum_post`;
   ```

2. **检查数据量**:
   ```sql
   SELECT COUNT(*) 
   FROM `ims_mdkeji_im_boniu_forum_post`
   WHERE avatar_url LIKE 'http://%' OR avatar_url LIKE 'https://%';
   ```

3. **在非高峰时段执行**: 下载和更新操作可能耗时较长

### 执行后验证

执行完成后，可以通过以下SQL查询验证结果：

```sql
-- 检查是否还有URL格式的头像
SELECT COUNT(*) 
FROM `ims_mdkeji_im_boniu_forum_post`
WHERE username IS NOT NULL 
  AND username != '' 
  AND username != '未知用户'
  AND (avatar_url LIKE 'http://%' OR avatar_url LIKE 'https://%');

-- 如果返回0，说明所有头像都已下载并更新

-- 查看本地头像统计
SELECT 
    COUNT(*) as total,
    COUNT(DISTINCT username) as unique_users,
    SUM(CASE WHEN avatar_url LIKE 'images/boniu/avatar/%' THEN 1 ELSE 0 END) as local_avatars
FROM `ims_mdkeji_im_boniu_forum_post`
WHERE username IS NOT NULL 
  AND username != '' 
  AND username != '未知用户';
```

## 🔍 功能特点

### 去重机制
- **用户名去重**: 相同用户名只下载一次头像
- **避免重复**: 如果用户名已存在映射中，直接跳过
- **节省资源**: 减少网络请求和存储空间

### 错误处理
- **下载失败**: 记录错误但继续处理其他记录
- **异常捕获**: 完善的异常处理机制
- **日志记录**: 详细的错误日志便于排查

### 性能优化
- **批量更新**: 使用批量更新提高数据库操作效率
- **进度显示**: 每100条记录显示一次进度
- **统计报告**: 详细的执行统计信息

## 🛠️ 故障排除

### 问题1: 下载速度慢
- **原因**: 网络连接或服务器响应慢
- **解决**: 这是正常情况，脚本会自动处理，耐心等待

### 问题2: 部分头像下载失败
- **原因**: URL失效或网络问题
- **解决**: 脚本会记录失败的头像，可以手动处理或重新运行

### 问题3: 数据库更新失败
- **原因**: 数据库连接问题或权限不足
- **解决**: 检查数据库连接配置和权限

### 问题4: 磁盘空间不足
- **原因**: 头像文件占用空间较大
- **解决**: 确保有足够的磁盘空间

## 📊 执行示例

### 成功执行示例

```
[2025-10-16 10:00:00] INFO: ============================================================
[2025-10-16 10:00:00] INFO: 开始执行历史头像下载脚本
[2025-10-16 10:00:00] INFO: ============================================================
[2025-10-16 10:00:00] INFO: 开始下载历史数据中的头像...
[2025-10-16 10:00:01] INFO: 查询需要下载头像的记录...
[2025-10-16 10:00:02] INFO: 找到 150 条需要下载头像的记录
[2025-10-16 10:00:03] INFO: 处理进度: 100/150, 已下载: 85, 跳过: 10, 错误: 5
[2025-10-16 10:05:00] INFO: 头像下载完成: 成功 120 个, 跳过 25 个, 失败 5 个
[2025-10-16 10:05:01] INFO: 开始更新数据库，共 120 个用户...
[2025-10-16 10:05:02] INFO: 开始批量更新 350 条记录...
[2025-10-16 10:05:03] INFO: 数据库更新完成，影响行数: 350
[2025-10-16 10:05:03] INFO: ============================================================
[2025-10-16 10:05:03] INFO: 更新统计:
[2025-10-16 10:05:03] INFO:   总记录数: 500
[2025-10-16 10:05:03] INFO:   URL格式头像: 0
[2025-10-16 10:05:03] INFO:   本地路径头像: 450
[2025-10-16 10:05:03] INFO:   空头像: 50
[2025-10-16 10:05:03] INFO: ============================================================
[2025-10-16 10:05:03] INFO: 数据库连接已关闭
[2025-10-16 10:05:03] INFO: ============================================================
[2025-10-16 10:05:03] INFO: 历史头像下载脚本执行完成
[2025-10-16 10:05:03] INFO: ============================================================
```

## ✅ 执行检查清单

- [ ] 已备份数据
- [ ] 已检查数据量
- [ ] 已配置环境变量
- [ ] 已确保有足够的磁盘空间
- [ ] 已选择合适的时间执行
- [ ] 执行后已运行验证查询
- [ ] 已检查日志文件

## 📚 相关文件

- `scripts/download_history_avatars.py` - 历史头像下载脚本
- `src/crawler/utils/image_downloader.py` - 图片下载工具
- `src/crawler/utils/db.py` - 数据库工具
